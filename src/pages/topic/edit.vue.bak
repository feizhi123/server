<template>
    <div>
        <div class="content bg-gray-lighter">
            <div class="row items-push">
                <div class="col-sm-7">
                    <h1 class="page-heading">
                        新增专题
                    </h1>
                </div>
            </div>
        </div>
        <div class="content">
            <div class="block">
                <div class="block-content block-content-narrow">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-md-2 control-label">专题标题</label>
                            <div class="col-md-7">
                                <input class="form-control" v-model="p.title" type="text" placeholder="标题">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-2 control-label">专题描述</label>
                            <div class="col-md-7">
                                <textarea rows=3              class="form-control" v-model="p.desc" type="text"
                                          placeholder="描述"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-2 control-label">上传专题图片</label>
                            <div class="col-md-7">
                                <file-wrapper class="btn btn-primary" @on-file-change="imgChange">
                                    <i class="fa fa-upload"></i>
                                    选择图片
                                </file-wrapper>
                            </div>
                        </div>
                        <div class="form-group" v-show="p.bannerUrl">
                            <label class="col-md-2 control-label"></label>
                            <div class="col-md-7">
                                <img class="img-responsive" :src="p.bannerUrl" alt="">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-2 control-label">添加问题</label>
                            <div class="col-md-3">
                                <input class="form-control" v-model="queryParams.queryStr"
                                       placeholder="输入用户昵称/问题标题/回答内容/话题标签">
                            </div>
                            <div class="col-md-1 text-left">
                                <button class="btn btn-primary btn-block" @click="search">搜索</button>
                            </div>
                        </div>
                        <div class="js-wizard-simple block">
                            <ul class="nav nav-tabs nav-tabs-alt nav-justified" style="width:400px;">
                                <li class="active">
                                    <a href="#simple-step1" data-toggle="tab">搜索列表({{questionsSearched.length}})</a>
                                </li>
                                <li>
                                    <a href="#simple-step2" data-toggle="tab"
                                       @click="checkAddedQues">已添加问题({{questionsAdded.length}})</a>
                                </li>
                                <li>
                                    <a href="#simple-step2" data-toggle="tab"
                                       @click="checkAddedQues">已添加问题({{questionsWatingAudit.length}})</a>
                                </li>
                            </ul>
                            <div class="block-content tab-content">
                                <div class="tab-pane fade in push-30-t push-50 active" id="simple-step1"
                                     style="width:600px;">
                                    <div v-for="(qSearched,index) in questionsSearched"
                                         :key="qSearched._id.$oid">
                                        <div class="flex-row list-item">
                                            <div class="list-left">
                                                <div class="quest-title">{{qSearched.title}}</div>
                                                <div class="flex-row" style="margin-top:7px">
                                                    <span style="margin-right:20px">回答({{qSearched.answerCount}})</span>
                                                    <span>提问时间：{{qSearched.createdAt.$date | date}}</span>
                                                </div>
                                            </div>

                                            <button class="btn btn-primary add-btn"
                                                    @click="addQuestions(qSearched)">添加
                                            </button>
                                            <router-link class="detail-link" to="/questionDetail">查看</router-link>
                                        </div>
                                    </div>
                                    <el-pagination
                                            @current-change="pageChange"
                                            :current-page.sync="queryParams.page"
                                            :page-size="queryParams.perPage"
                                            layout="prev, pager, next, jumper"
                                            :total="totalCount" style="text-align:center">
                                    </el-pagination>
                                </div>
                                <div class="tab-pane fade push-30-t push-50" id="simple-step2" style="width:600px;"
                                     @show.bs.tab="checkAddedQues">
                                    <div v-for="(qAdded,index) in questionsAdded" :key="qAdded._id.$oid">
                                        <div class="flex-row list-item">
                                            <div class="list-left">
                                                <div class="quest-title">{{qAdded.title}}</div>
                                                <div class="flex-row" style="margin-top:7px">
                                                    <span style="margin-right:20px">回答({{qAdded.answerCount}})</span>
                                                    <span>提问时间：{{qAdded.createdAt.$date | date}}</span>
                                                </div>
                                            </div>

                                            <button class="btn btn-primary add-btn"
                                                    @click="removeConfirm(qAdded._id.$oid)">删除
                                            </button>
                                            <router-link class="detail-link" to="/questionDetail">查看</router-link>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!--<div class="form-group">-->
                        <!--<div class="col-md-2 col-md-offset-2">-->
                        <!--<span class="red-font" v-show="showWording">{{wording}}</span>-->
                        <!--</div>-->
                        <!--</div>-->
                        <div class="form-group">
                            <div class="col-md-2 col-md-offset-2">
                                <a class="btn btn-success btn-block" @click="save">确定</a>
                            </div>
                            <div class="col-md-2 col-md-offset-2">
                                <a class="btn btn-success btn-block" @click="cancelConfirm">取消</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <confirm title="提示！" :content="confirmWording" :show="showModal" @confirm="remove" @show="showModal=true"
                 @hide="showModal=false"></confirm>
    </div>


</template>

<script>
    import COS from '@/utils/cos'
    import FileWrapper from '@/components/file-upload-wrapper'
    import topicApi from '@/services/topic'
    import Confirm from "@/components/confirm";

    export default {
        components: {
            FileWrapper, Confirm
        },
        mounted() {
            let vm = this;
            loadData();
        },
        props: {},
        data() {
            return {
                p: {
                    title: '',
                    desc: '',
                    bannerUrl: '',
                    questionIds: []
                },
                questionsAdded: [
//                    {
//                    answerCount: 11,
//                    _id: {$oid: "5abde72150d35953e088b931"},
//                    createdAt: {$date: 1521379440581},
//                    title: "添加的问题"
//                }
                ]
                ,
                questionsSearched: [
//                    {
//                    answerCount: 2,
//                    _id: {$oid: "5abde72150d35953e088b931"},
//                    createdAt: {$date: 1521379440581},
//                    title: "搜到的问题?"
//                }
                ],
                questionsWatingAudit: [
                    {
                        answerCount: 2,
                        _id: {$oid: "5abde72150d35953e088b931"},
                        createdAt: {$date: 1521379440581},
                        title: "搜到的问题?"
                    }
                ],
                showModal: false,
                confirmWording: '',
                totalCount: 10,
                removeQuestionId: '',
                lastQueryWithOptions: false,
                queryParams: {
                    page: 1,
                    perPage: 10,
                    queryStr: ''
                },
                questionEmpty: 0,
                wording: '',
                showWording: false,
                actFn: ''

            }
        },
        methods: {
            imgChange(file) {
                let vm = this;
                COS.uploadFile(file).then(data => {
                    vm.p.bannerUrl = data.path
                })
            },
            loadData() {
                let vm = this;
                let topicId = vm.$route.params.topicId;
                topicApi.detail(topicId).then(data => {
                    vm.p = data.data;
                })

            },
            addQuestions(question) {
                let vm = this;
                vm.questionsAdded.push(question);
                vm.showWording = false;
            },
            deleteAddedQuestion(questionId) {
                let vm = this;
                let qs = vm.questionsAdded;
                for (let i = 0; i < qs.length; i++) {
                    if (qs[i]._id.$oid === questionId) {
                        qs.splice(i, 1);
                        if (qs.length === 0) {
                            vm.showWord('该专题下还没有问题，快去添加吧');
                        }
                        return;
                    }
                }

            },
            removeConfirm(questionId, actFn) {
                this.removeQuestionId = questionId;
                this.showModal = true;
                this.actFn = actFn;
            },
            remove() {
                let vm = this;
                vm.deleteAddedQuestion(vm.removeQuestionId);
            },
            doConfirm(fn) {
                fn();
            },
            search() {
                let vm = this;
                topicApi.searchQuestions(vm.queryParams).then(data => {
                    vm.totalCount = data.totalCount;
                    vm.questionsSearched = data.list;
                })
            },
            pageChange(page) {
                let vm = this;
                vm.queryParams.page = page;
                vm.search();
            },
            save() {
                let vm = this;
                vm.p.questionIds = [];
                for (let qs of vm.questionsAdded) {
                    vm.p.questionIds.push(qs._id.$oid);
                }
                let qCount = vm.p.questionIds.length;
                if (qCount === 0) {
                    vm.showWord('问题不能为空');
                    return;
                }
                topicApi.createTopic(this.p).then(data => {
                    vm.$message.success('添加成功！');
                    vm.$router.push('/topicList')
                })
            },
            checkAddedQues() {
                let vm = this;
                if (vm.questionsAdded.length === 0)
                    vm.showWord('该专题下还没有问题，快去添加吧');
            },
            showWord(wording) {
                let vm = this;
                vm.wording = wording;
                vm.showWording = true;
            },
            cancelConfirm() {
                let vm = this;
                vm.wording = '确定要取消吗，你编辑的内容都将不再保存？';
                vm.showModal = true;
            }

        }
    }
</script>

<style lang="scss" scoped>
    .spec {
        background: #eee;
        margin-top: 20px;
    }

    .spec-label {
        padding-top: 7px;
    }

    .list-left {
        flex: 1
    }

    .list-item {
        padding-bottom: 15px;
        border-bottom: 1px #ddd solid;
    }

    .quest-title {
        font-size: 14px;
        font-weight: bold;
    }

    .add-btn {
        width: 80px;
    }

    .detail-link {
        width: 80px;
        text-align: center;
    }
</style>